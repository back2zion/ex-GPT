# ex-GPT 고도화 프로젝트 Global Rules

## 프로젝트 가이드라인

### 문서화 요구사항
- 새로운 기능 수정 시 `/docs` 디렉토리의 관련 문서 업데이트 필수
- README.md를 새로운 기능과 동기화 유지
- CHANGELOG.md에 변경사항 엔트리 관리
- 한국도로공사 특수성을 고려한 기술 문서 작성 (보안성, 안정성 중점)

### 아키텍처 결정 기록 (ADR)
다음 사항에 대해 `/docs/adr`에 ADR 생성:
- 주요 의존성 변경 (Poetry 환경의 새로운 패키지 추가/제거)
- 아키텍처 패턴 변경 (RAG 파이프라인, LLM 추론 구조 등)
- 새로운 통합 패턴 (Qdrant 연동, Whisper STT, H100 GPU 최적화 등)
- 데이터베이스 스키마 변경 (벡터 DB 구조, 세션 관리 등)
- AI 모델 변경 (Llama3 → QWen3, 임베딩 모델 교체 등)

템플릿: `/docs/adr/template.md` 준수

### 코드 스타일 및 패턴

#### Python/Flask 개발 기준
- **Poetry 환경 관리**: 모든 의존성은 `pyproject.toml`에서 관리
- **Flask 애플리케이션 구조**: 모듈화된 라우트 및 블루프린트 사용
- **AI 모델 관리**: 컴포지션 패턴으로 모델 래퍼 클래스 구현
- **에러 핸들링**: `/src/utils/errors.ts` 패턴을 Python으로 적용한 중앙집중식 에러 처리
- **비동기 처리**: GPU 추론, STT 처리를 위한 ThreadPoolExecutor 활용

#### ex-GPT 특화 패턴
- **RAG 파이프라인**: Repository 패턴으로 Qdrant 데이터 액세스 추상화
- **LLM 추론**: Factory 패턴으로 Ollama/GPU 모델 선택적 로딩
- **음성 처리**: Strategy 패턴으로 Whisper/Faster-Whisper/Transformers 선택적 사용
- **세션 관리**: 한국도로공사 기존 와이즈넛 권한 체계와 호환되는 세션 패턴

#### 코드 품질 기준
```python
# 예시: ex-GPT 스타일 가이드
class AudioProcessor:
    """음성 처리 클래스 - 컴포지션 패턴 적용"""
    
    def __init__(self, whisper_model, device="cuda:0"):
        self.whisper_model = whisper_model
        self.device = device
        self.session_manager = SessionManager()
    
    async def process_audio(self, audio_file, user_id):
        """비동기 음성 처리 - 에러 핸들링 포함"""
        try:
            session_id = self.session_manager.create_session(user_id)
            result = await self._transcribe_with_progress(audio_file, session_id)
            return result
        except AudioProcessingError as e:
            logger.error(f"음성 처리 오류: {e}")
            raise
```

### 테스트 표준

#### 유닛 테스트 (필수)
- **비즈니스 로직**: RAG 검색, LLM 추론, 음성 처리 로직
- **AI 모델 래퍼**: 모델 로딩, 추론, 후처리 함수
- **유틸리티 함수**: 텍스트 전처리, 임베딩 생성, 세션 관리

#### 통합 테스트 (필수)
- **API 엔드포인트**: `/api/chat`, `/api/upload_voice`, `/api/qdrant_status`
- **외부 시스템 연동**: Qdrant 벡터DB, Ollama LLM 서버
- **H100 GPU 연동**: CUDA 메모리 관리, 모델 로딩 테스트

#### E2E 테스트 (핵심 플로우)
- **대화 흐름**: 사용자 질의 → RAG 검색 → LLM 응답 → 결과 반환
- **음성 처리 흐름**: 음성 업로드 → STT → 요약 → 이메일 전송
- **관리자 기능**: 문서 업로드 → 벡터화 → 검색 가능성 검증

### ex-GPT 특화 개발 기준

#### AI/ML 모델 관리
```python
# 모델 버전 관리
MODEL_VERSIONS = {
    'embedding': 'paraphrase-multilingual-MiniLM-L12-v2',
    'whisper': 'openai/whisper-large-v3',
    'llm_primary': 'qwen3-235b',  # H100 환경
    'llm_fallback': 'llama3-70b'  # 호환성 보장
}

# GPU 메모리 관리
class GPUMemoryManager:
    """H100 GPU 메모리 최적화 관리"""
    
    def allocate_model(self, model_type, device_id=0):
        """모델별 GPU 메모리 할당 전략"""
        pass
```

#### 보안 및 권한 관리
- **개인정보 보호**: 월별 점검 시스템 구현 (휴먼 인 더 루프)
- **권한 체계**: 기존 와이즈넛 시스템과 호환되는 세션 기반 권한 관리
- **감사 로그**: 모든 AI 응답과 사용자 상호작용 기록

#### 성능 최적화
- **GPU 활용**: H100 8장 환경에서의 멀티-GPU 추론 최적화
- **메모리 관리**: 대용량 모델 로딩을 위한 메모리 풀 관리
- **캐싱 전략**: Qdrant 검색 결과 및 LLM 응답 캐싱

### 배포 및 운영

#### 개발 환경 설정
```bash
# Poetry 환경 설정
poetry install
poetry shell

# GPU 환경 검증
python -c "import torch; print(torch.cuda.is_available())"

# 의존성 서비스 실행
docker-compose up -d qdrant ollama
```

#### 환경별 설정
- **개발환경**: CPU 모드, 로컬 Qdrant
- **스테이징환경**: GPU 시뮬레이션, 클라우드 Qdrant
- **운영환경**: H100 GPU, 고가용성 Qdrant 클러스터

#### 모니터링 및 로깅
- **GPU 사용률**: H100 GPU 메모리, 온도, 활용률 실시간 모니터링
- **응답 시간**: LLM 추론, RAG 검색, STT 처리 시간 추적
- **에러 추적**: AI 모델 오류, 시스템 리소스 부족 상황 알림

### 협업 기준 (DataStreams-NeoAli)

#### 역할 분담 (R&R Matrix 기반)
- **DataStreams**: 데이터 준비, 전처리, 시스템 통합, 권한 관리
- **NeoAli**: AI 모델 최적화, 벡터DB 관리, 멀티모달 처리

#### 코드 리뷰 기준
- **기술적 리뷰**: AI 모델 성능, GPU 최적화, 메모리 효율성
- **비즈니스 리뷰**: 한국도로공사 요구사항 충족도, 사용자 경험
- **보안 리뷰**: 개인정보 처리, 권한 관리, 감사 로그

#### 브랜치 전략
```
main (운영 배포)
├── develop (개발 통합)
├── feature/rag-optimization (RAG 성능 개선)
├── feature/h100-integration (H100 GPU 최적화)
├── feature/stt-enhancement (음성 처리 고도화)
└── hotfix/security-patch (보안 패치)
```

### 품질 보증

#### 성능 기준
- **응답 시간**: 텍스트 질의 < 3초, 음성 처리 < 30초
- **정확도**: RAG 검색 관련성 > 85%, STT 정확도 > 95%
- **가용성**: 99.5% 업타임 (7월 1일 오픈 이후)

#### 코드 품질 메트릭
- **테스트 커버리지**: 핵심 비즈니스 로직 > 80%
- **코드 복잡도**: McCabe 복잡도 < 10
- **의존성 관리**: Poetry lock 파일 최신 상태 유지

#### AI 모델 품질 관리
- **모델 드리프트**: 주간 성능 모니터링 및 재훈련 기준
- **편향성 검사**: 한국도로공사 업무 도메인 특화 검증
- **안전성 검증**: 부적절한 응답 필터링 및 휴먼 검토 시스템

---

**참고 문서**:
- [ex-GPT 프로젝트 종합 보고서](https://back2zion.github.io/0610ex-GPT/analysis.html)
- [DataStreams-NeoAli R&R Matrix](https://docs.google.com/spreadsheets/d/10hbcNPVAu4mTWOJywyjy_3pxVJ4vUFGA40f4QEAjow4/edit)
- [기술 협상 회의록](https://docs.google.com/document/d/12z30_Z7bNMolyjBNglBCgdbIGi8HDpAvVsJ35gS8y9E/edit)